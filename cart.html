
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrello - Cronoshop</title>
    <meta name="description" content="Visualizza e gestisci i prodotti nel tuo carrello Cronoshop prima di procedere all'acquisto su Amazon.">
    <link rel="canonical" href="https://www.cronoshop.eu/cart.html">
    <link rel="icon" type="image/png" href="assets/cronoshop-logo.png">
    <link rel="apple-touch-icon" href="assets/cronoshop-logo.png">
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        body { padding-top: 70px; }
        .container { max-width: 1200px; margin: 0 auto; padding: 40px 20px; }
        .page-header { text-align: center; margin-bottom: 40px; }
        .page-header h1 { font-size: 2.5rem; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 12px; }
        .cart-layout { display: grid; grid-template-columns: 2fr 1fr; gap: 32px; align-items: start; }
        .cart-items-section { display: flex; flex-direction: column; gap: 16px; }
        .cart-item { display: flex; background: var(--ios-bg-secondary); border-radius: var(--ios-radius-lg); padding: 16px; gap: 16px; align-items: center; border: 1px solid var(--ios-separator-non-opaque); }
        .cart-item-img { width: 80px; height: 80px; object-fit: cover; border-radius: var(--ios-radius-md); flex-shrink: 0; }
        .cart-item-details { flex-grow: 1; }
        .cart-item-title { font-weight: 600; }
        .cart-item-price { color: var(--ios-text-secondary); }
        .quantity-controls { display: flex; align-items: center; gap: 8px; }
        .quantity-btn { width: 30px; height: 30px; }
        .cart-summary-card { background: var(--ios-bg-secondary); border-radius: var(--ios-radius-xl); padding: 24px; border: 1px solid var(--ios-separator-non-opaque); position: sticky; top: 90px; }
        .summary-row { display: flex; justify-content: space-between; margin-bottom: 12px; }
        .total-row { font-weight: 700; font-size: 1.2rem; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--ios-separator-non-opaque); }
        .empty-state { text-align: center; padding: 60px 20px; background: var(--ios-bg-secondary); border-radius: var(--ios-radius-xl); }
        @media (max-width: 992px) { .cart-layout { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div id="navbar-placeholder"></div>

    <main class="container">
        <div class="page-header">
            <h1><i class="ph ph-shopping-cart"></i> Il Tuo Carrello</h1>
        </div>

        <div class="cart-layout" id="cartLayout" style="display: none;">
            <div>
                <div id="cartItemsContainer" class="cart-items-section">
                    </div>
                 <button class="ios-btn ios-btn-secondary" id="clearCartBtn" style="width: 100%; margin-top: 16px;">
                    <i class="ph ph-trash"></i> Svuota Carrello
                </button>
            </div>

            <div class="cart-summary-section">
                <div class="cart-summary-card">
                    <h3>Riepilogo</h3>
                    <div class="summary-row" style="margin-top: 24px;">
                        <span>Subtotale (<span id="itemCount">0</span> articoli)</span>
                        <span id="subtotal">€0.00</span>
                    </div>
                    <div class="summary-row">
                        <span>Spedizione</span>
                        <span>Gratuita</span>
                    </div>
                    <div class="summary-row total-row">
                        <span>Totale</span>
                        <span id="total">€0.00</span>
                    </div>
                    <button class="ios-btn ios-btn-primary" id="checkoutBtn" style="width: 100%; margin-top: 24px;">
                        <i class="ph ph-credit-card"></i> Procedi all'Acquisto su Amazon
                    </button>
                    <p style="font-size: 0.8rem; color: var(--ios-text-secondary); text-align: center; margin-top: 16px;">Verrai reindirizzato su Amazon per completare l'ordine in sicurezza.</p>
                </div>
            </div>
        </div>

        <div class="empty-state" id="emptyCartState" style="display: none;">
            <h3>Il tuo carrello è vuoto</h3>
            <p style="color: var(--ios-text-secondary); margin-top: 8px; margin-bottom: 24px;">Esplora le nostre offerte e aggiungi i prodotti che desideri acquistare.</p>
            <a href="products.html" class="ios-btn ios-btn-primary">
                <i class="ph ph-shopping-bag"></i> Vai alle Offerte
            </a>
        </div>
    </main>

    <div id="footer-placeholder"></div>

    <script src="main.js"></script>
    <script src="script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const cartContainer = document.getElementById('cartItemsContainer');
            const emptyState = document.getElementById('emptyCartState');
            const cartLayout = document.getElementById('cartLayout');
            const clearCartBtn = document.getElementById('clearCartBtn');
            const checkoutBtn = document.getElementById('checkoutBtn');

            // Elementi del riepilogo
            const itemCountEl = document.getElementById('itemCount');
            const subtotalEl = document.getElementById('subtotal');
            const totalEl = document.getElementById('total');

            let cart = JSON.parse(localStorage.getItem('cronoshop_cart') || '[]');

            function renderCart() {
                cartContainer.innerHTML = '';

                if (cart.length === 0) {
                    emptyState.style.display = 'block';
                    cartLayout.style.display = 'none';
                } else {
                    emptyState.style.display = 'none';
                    cartLayout.style.display = 'grid';

                    cart.forEach(item => {
                        const itemEl = document.createElement('div');
                        itemEl.className = 'cart-item';
                        itemEl.innerHTML = `
                            <img src="${item.img}" alt="${item.nome}" class="cart-item-img">
                            <div class="cart-item-details">
                                <div class="cart-item-title">${item.nome}</div>
                                <div class="cart-item-price">€${parseFloat(item.prezzo).toFixed(2)}</div>
                            </div>
                            <div class="quantity-controls">
                                <button class="ios-btn ios-btn-secondary ios-btn-icon quantity-btn" onclick="updateQuantity('${item.id}', -1)">-</button>
                                <span>${item.quantity}</span>
                                <button class="ios-btn ios-btn-secondary ios-btn-icon quantity-btn" onclick="updateQuantity('${item.id}', 1)">+</button>
                            </div>
                            <button class="ios-btn ios-btn-secondary ios-btn-icon" onclick="removeFromCart('${item.id}')" title="Rimuovi">
                                <i class="ph ph-trash"></i>
                            </button>
                        `;
                        cartContainer.appendChild(itemEl);
                    });
                }
                updateSummary();
                if (window.cronoshopNav && typeof window.cronoshopNav.updateBadges === 'function') {
                    window.cronoshopNav.updateBadges();
                }
            }

            function updateSummary() {
                const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
                const subtotal = cart.reduce((sum, item) => sum + (item.prezzo * item.quantity), 0);

                itemCountEl.textContent = totalItems;
                subtotalEl.textContent = `€${subtotal.toFixed(2)}`;
                totalEl.textContent = `€${subtotal.toFixed(2)}`;
            }

            window.updateQuantity = (productId, change) => {
                const item = cart.find(p => p.id === productId);
                if (item) {
                    item.quantity += change;
                    if (item.quantity <= 0) {
                        removeFromCart(productId);
                    } else {
                        saveAndRender();
                    }
                }
            };

            window.removeFromCart = (productId) => {
                cart = cart.filter(p => p.id !== productId);
                app.showNotification('Prodotto rimosso dal carrello', 'success');
                saveAndRender();
            };

            clearCartBtn.addEventListener('click', () => {
                if (confirm('Sei sicuro di voler svuotare il carrello?')) {
                    cart = [];
                    app.showNotification('Carrello svuotato!', 'success');
                    saveAndRender();
                }
            });

            // --- SEZIONE CORRETTA ---
            checkoutBtn.addEventListener('click', () => {
                if (cart.length === 0) {
                    app.showNotification('Il carrello è vuoto.', 'error');
                    return;
                }
                
                app.showNotification(`Stai per aprire ${cart.length} schede su Amazon...`, 'info');

                // Itera su ogni prodotto nel carrello e apre il suo link specifico.
                // Il piccolo ritardo tra un'apertura e l'altra aiuta a prevenire
                // che il browser blocchi le finestre pop-up.
                cart.forEach((item, index) => {
                    if (item.link) {
                        setTimeout(() => {
                            window.open(item.link, '_blank');
                        }, index * 200); // Apre una scheda ogni 200 millisecondi
                    } else {
                        console.warn(`Prodotto ${item.id} senza link.`);
                    }
                });
            });
            // --- FINE SEZIONE CORRETTA ---

            function saveAndRender() {
                localStorage.setItem('cronoshop_cart', JSON.stringify(cart));
                renderCart();
            }

            renderCart();
        });
    </script>
    <script>
    // Funzione per caricare componenti HTML esterni
    function loadComponent(url, placeholderId) {
        fetch(url)
            .then(response => response.ok ? response.text() : Promise.reject('Errore nel caricamento'))
            .then(data => {
                const placeholder = document.getElementById(placeholderId);
                if (!placeholder) return;
                
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = data;
                
                // Estrai e aggiungi al DOM gli stili e gli script dalla navbar caricata
                // Questi gestiscono i tag <style> e <script> che erano dentro nav.html/footer.html
                tempDiv.querySelectorAll('style').forEach(styleTag => {
                    const newStyle = document.createElement('style');
                    newStyle.textContent = styleTag.textContent;
                    document.head.appendChild(newStyle);
                });

                tempDiv.querySelectorAll('script').forEach(scriptTag => {
                    const newScript = document.createElement('script');
                    if (scriptTag.src) {
                        newScript.src = scriptTag.src;
                    } else {
                        newScript.textContent = scriptTag.textContent;
                    }
                    document.body.appendChild(newScript);
                });

                // Inserisci il contenuto HTML (senza gli script/stili già spostati)
                // Usiamo un clone per evitare di reinserire gli script/stili
                const contentToInsert = tempDiv.cloneNode(true); 
                contentToInsert.querySelectorAll('style, script').forEach(el => el.remove()); // Rimuovi gli script/stili dal clone
                placeholder.innerHTML = contentToInsert.innerHTML;
            })
            .catch(error => console.error(`Impossibile caricare ${url}: ${error}`));
    }

    // Inizializza al caricamento del DOM
    document.addEventListener('DOMContentLoaded', () => {
        loadComponent('nav.html', 'navbar-placeholder');
        loadComponent('footer.html', 'footer-placeholder');
        // Se hai altri script specifici della pagina che devono inizializzare qualcosa
        // dopo che tutti i componenti sono caricati (es. la classe CronoAI per cronoai.html),
        // assicurati di chiamarli qui.
        // ESEMPIO: if (window.CronoAI) { window.cronoAI = new CronoAI(); }
        // Oppure, se CronoAI è già un'istanza globale e si inizializza da sola, non serve altro.
    });
</script>

</body>
</html>
